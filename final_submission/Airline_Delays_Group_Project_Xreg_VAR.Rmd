---
title: "Group_Project_EF"
output: html_document
date: '2022-08-04'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Install Packages

```{r, message=FALSE}
library(fpp)
library(tseries)
library(ggplot2)
library(forecast)
library(TSstudio)
library(MLmetrics)
library(vars)
library(dplyr)
library(TSA)
```

## Importing Data

Import raw data. Selecting data for all providers and airlines. Data is by month by provider, so need to aggregate by month.

```{r load}
data <- read.csv('C:/Users/ethan/OneDrive/Documents/UChicago/Time Series Analysis/Group_Project/BTS_Airline_Delay_Data.csv')
data[is.na(data)] <- 0
data$date <- as.Date(paste(data$year,'-',data$month,'-','01', sep = ''))
flights <- data %>% group_by(date) %>%
  summarise(flights = sum(arr_flights), delays = sum(arr_del15), carrier = sum(carrier_ct),
            weather = sum(weather_ct), nas = sum(nas_ct), security = sum(security_ct), 
            late_aircraft = sum(late_aircraft_ct), late_aircraft = sum(late_aircraft_ct),
            cancellation = sum(arr_cancelled), diversions = sum(arr_diverted))
flights = subset(flights, select = -c(date))
flights_ts <- ts(flights, start = c(2003,6), frequency = 12)
total_flights <- flights_ts[,1]
total_delays <- flights_ts[,2]
total_flights_pre_covid <- window(total_flights, end=2019.99)
total_delays_pre_covid <- window(total_delays, end=2019.99)

train <- ts(total_delays[1:187], start = c(2003,6), frequency = 12)
test <- ts(total_delays[188:200], start = c(2019,1), frequency = 12)

train_flights <- ts(total_flights[1:187], start = c(2003,6), frequency = 12)
test_flights <- ts(total_flights[188:200], start = c(2019,1), frequency = 12)

train_covid <- ts(total_delays[1:216], start = c(2003,6), frequency = 12)
test_covid <- ts(total_delays[217:228], start = c(2021,6), frequency = 12)

train_covid_flights <- ts(total_flights[1:216], start = c(2003,6), frequency = 12)
test_covid_flights <- ts(total_flights[217:228], start = c(2021,6), frequency = 12)
```


## ARIMA W/ XREG
```{r 1}

fit1 <- auto.arima(train, xreg=train_flights)
forecast1 <- forecast(fit1, xreg=test_flights, h=12)
accuracy(forecast1, test)
plot(train, main='Actuals vs Fit')
lines(fitted(fit1),col = "red", lty=2)
legend('topright', legend=c('actual','fitted'), lty=c(1,2), col=c("black", "red"))
ts.plot(cbind(train, test, forecast1$mean), lty=1:3, col=1:3, main = 'ARIMA W/ XREG (Total Flights)')
legend('topright', legend = c('train','test','forecast'), col=1:3, lty=1:3 )

```

## VAR

```{r 2}
#A. all
var_delays <- VAR(cbind(train, train_flights), p=10, type ='both', season=12)
summary(var_delays)

#forecast
var_delays_fcst<-forecast(train, h=12)
plot(var_delays_fcst)

#acf
acf(residuals(var_delays))

#serial test
serial.test(var_delays, lags.pt=10,type='PT.asymptotic')

```